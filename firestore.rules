rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- USER DATA ---
    match /artifacts/{namespace}/users/{userId} {
      // Profile data is public to read, but only the owner can write.
      match /profile/data {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      // Comments are public to read. Logged-in users can create.
      // Owner or author can delete/update.
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null && request.auth.uid == resource.data.authorUid;
        allow delete: if request.auth != null &&
          (request.auth.uid == userId || request.auth.uid == resource.data.authorUid);
      }
      // Notifications are private.
      match /notifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    match /{path=**}/profile/{docId} {
        allow get, list: if request.auth != null;
    }

    // --- PUBLIC GAME DATA ---
    match /game-settings/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    match /dci-data/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    match /dci-stats/{docId} {
      allow read: if true;
      allow write: if false; // Backend only
    }
    match /fantasy_recaps/{docId} {
      allow read: if true;
      allow write: if false; // Backend only
    }
    match /final_rankings/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    match /historical_scores/{docId} {
      allow read: if true;
      allow write: if false; // Backend only
    }
    match /live_scores/{seasonId}/scores/{docId} {
      allow read: if true;
      allow write: if false; // Backend only
    }
    
    match /schedules/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }


    // --- LEAGUES ---
    match /leagues/{leagueId} {
      // Admins can read any league, members can read their own.
      allow read: if request.auth != null && (request.auth.uid in resource.data.members || request.auth.token.admin == true);
      allow write: if false; // Writes handled by backend functions
    }
    match /leagues/{leagueId}/matchups/{week} {
      allow read: if request.auth != null;
      allow write: if false; // Backend only
    }
    match /leagueInvites/{code} {
      allow read, write: if false; // Backend only
    }

    // --- MISC & ADMIN ---
    match /activeLineups/{lineupKey} {
      allow read, write: if false; // Backend only
    }
    match /usernames/{username} {
      allow read: if true;
      allow write: if false; // Backend only
    }
    match /reports/{reportId} {
      allow read, update: if request.auth != null && request.auth.token.admin == true;
      allow create: if request.auth != null;
    }
  }
}