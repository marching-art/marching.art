rules_version = '2';service cloud.firestore {match /databases/{database}/documents {// Helper functions
function isAuthenticated() {
  return request.auth != null;
}

function isAdmin() {
  // Check for the admin UID from your development guidelines
  return isAuthenticated() && (request.auth.uid == 'o8vfRCOevjTKBY0k2dISlpiYiIH2' || request.auth.token.admin == true);
}

function isOwner(userId) {
  return isAuthenticated() && request.auth.uid == userId;
}

// --- USER DATA ---
// This path now uses {appId} to match our React code and guidelines
match /artifacts/{appId}/users/{userId} {

  // Profile data is public to read, owner or admin can write
  // This is correct for leaderboards and public profiles.
  match /profile/data {
    allow read: if true; 
    allow write: if isOwner(userId) || isAdmin();
  }
  
  // Comments are public to read. Logged-in users can create.
  match /comments/{commentId} {
    allow read: if true;
    allow create: if isAuthenticated();
    allow update: if isAuthenticated() && request.auth.uid == resource.data.authorUid;
    allow delete: if isAuthenticated() && 
      (request.auth.uid == userId || request.auth.uid == resource.data.authorUid || isAdmin());
  }
  
  // Notifications are private
  match /notifications/{notificationId} {
    allow read, write: if isOwner(userId);
  }
  
  // All other user subcollections (like corps data, staff rosters, etc.)
  // can be read by any logged-in user (for leaderboards/profile viewing)
  // but only written to by the owner or an admin.
  match /{subcollection}/{document=**} {
    allow read: if isAuthenticated();
    allow write: if isOwner(userId) || isAdmin();
  }
}

// Collection group query for profiles (needed for leaderboards/dashboard)
match /{path=**}/profile/{docId} {
  allow read: if isAuthenticated();
}

// --- LEADERBOARD DATA ---
// Allow public read access to leaderboard subcollections
match /artifacts/{appId}/leaderboard/{timeframe}/{classType} {
  allow read: if true;
  allow write: if false; // Backend only
}

// Allow reading documents within leaderboard class collections
match /artifacts/{appId}/leaderboard/{timeframe}/{classType}/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

// --- PUBLIC GAME DATA (READ-ONLY FOR USERS) ---
// This structure from your file is perfect.
match /game-settings/{docId} {
  allow read: if true;
  allow write: if isAdmin();
}

match /dci-data/{docId} {
  allow read: if true;
  allow write: if isAdmin();
 
  // Allow reading subcollections like corpsValues
  match /{subcollection}/{document=**} {
    allow read: if true;
    allow write: if isAdmin();
  }
}

match /dci-stats/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /fantasy_recaps/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /season_champions/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /final_rankings/{docId} {
  allow read: if true;
  allow write: if isAdmin();
}

match /historical_scores/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /live_scores/{seasonId}/scores/{docId} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /schedules/{docId} {
  allow read: if true;
  allow write: if isAdmin();
}

// --- LEAGUES ---
// Updated to support new league features
match /artifacts/{appId}/leagues/{leagueId} {
  allow list: if isAuthenticated(); // Allows querying for leagues
  allow get: if isAuthenticated() &&
    (request.auth.uid in resource.data.members || isAdmin());
  allow write: if false; // Backend functions only

  // League standings
  match /standings/{docId} {
    allow read: if isAuthenticated() &&
      (request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/leagues/$(leagueId)).data.members || isAdmin());
    allow write: if false; // Backend only
  }

  // League matchups
  match /matchups/{week} {
    allow read: if isAuthenticated() &&
      (request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/leagues/$(leagueId)).data.members || isAdmin());
    allow write: if false; // Backend only
  }

  // League chat
  match /chat/{messageId} {
    allow read: if isAuthenticated() &&
      (request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/leagues/$(leagueId)).data.members || isAdmin());
    allow write: if false; // Backend only (via cloud function)
  }

  // League trades
  match /trades/{tradeId} {
    allow read: if isAuthenticated() &&
      (request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/leagues/$(leagueId)).data.members || isAdmin());
    allow write: if false; // Backend only
  }
}

match /leagueInvites/{code} {
  allow read: if isAuthenticated();
  allow write: if false; // Backend only
}

// --- MISC & ADMIN ---
match /activeLineups/{lineupKey} {
  allow read, write: if false; // Backend only
}

match /usernames/{username} {
  allow read: if true;
  allow write: if false; // Backend only
}

match /reports/{reportId} {
  allow read, update: if isAdmin();
  allow create: if isAuthenticated();
}

// Season settings (needed for dashboard)
match /season_settings/{docId} {
  allow read: if true;
  allow write: if isAdmin();
}

// Seasons collection (needed for Scores page)
match /seasons/{seasonId} {
  allow read: if true;
  allow write: if isAdmin();
}

// --- STAFF MANAGEMENT ---
// Staff database for marketplace
match /staff_database/{staffId} {
  allow read: if true; // Public marketplace
  allow write: if isAdmin(); // Admin only
}

// Staff marketplace listings (user-to-user sales)
match /staff_marketplace/{listingId} {
  allow read: if true;
  allow create: if isAuthenticated();
  allow update, delete: if isAuthenticated() &&
    (request.auth.uid == resource.data.sellerId || isAdmin());
}
}}